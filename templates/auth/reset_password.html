{% extends "base.html" %}

{% block title %}Reset Password{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/premium-auth.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

{% endblock %}

{% block content %}
<div class="auth-container">
    <!-- Left Side - Branding -->
    <div class="auth-branding">
        <div class="branding-content">
            <div class="brand-logo">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <defs>
                        <linearGradient id="gradient1" x1="2" y1="2" x2="22" y2="12">
                            <stop offset="0%" stop-color="#667eea" />
                            <stop offset="100%" stop-color="#764ba2" />
                        </linearGradient>
                        <linearGradient id="gradient2" x1="2" y1="7" x2="22" y2="22">
                            <stop offset="0%" stop-color="#f093fb" />
                            <stop offset="100%" stop-color="#f5576c" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <h1 class="brand-title">Create New<br><span class="highlight">Password</span></h1>
            <p class="brand-description">Your new password must be different from previously used passwords. Make it
                strong and memorable!</p>

            <div class="info-cards">
                <div class="info-card">
                    <div class="info-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                    </div>
                    <div>
                        <h3 style="font-size:xx-large; color:rgb(0, 0, 0)">Strong Password</h4>
                            <p style="font-size: larger; color:rgb(0, 0, 0)">Use at least 8 characters with numbers and letters
                            </p>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                        </svg>
                    </div>
                    <div>
                        <h3 style="font-size:xx-large; color:rgb(0, 0, 0)">Stay Secure</h4>
                            <p style="font-size: larger; color:rgb(0, 0, 0)">Don't share your password with anyone</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="decorative-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>
    </div>

    <!-- Right Side - Form -->
    <div class="auth-form-section">
        <div class="form-container wide-form">
            <div class="form-header">
                <div class="header-icon success-icon">
                    <svg width="56" height="56" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="url(#iconGradient)" stroke-width="2" />
                        <path d="M8 12l2 2 4-4" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round" />
                        <defs>
                            <linearGradient id="iconGradient" x1="2" y1="2" x2="22" y2="22">
                                <stop offset="0%" stop-color="#10b981" />
                                <stop offset="100%" stop-color="#059669" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h2>Set New Password</h2>
                <p>Create a strong password for your account</p>
            </div>

            {% if error %}
            <div class="alert alert-error">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                {{ error }}
            </div>
            {% endif %}

            {% if success %}
            <div class="alert alert-success">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                </svg>
                {{ success }}
            </div>
            {% endif %}

            <form method="POST" class="auth-form" id="resetPasswordForm">
                <div class="form-group">
                    <label for="new_password">New Password <span class="required">*</span></label>
                    <div class="input-container">
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                        <input type="password" id="new_password" name="new_password" placeholder="Enter new password"
                            required autocomplete="new-password" minlength="8">
                        <button type="button" class="password-toggle" onclick="togglePasswordField('new_password')">
                            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <svg class="eye-closed hidden" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path
                                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" />
                                <line x1="1" y1="1" x2="23" y2="23" />
                            </svg>
                        </button>
                    </div>

                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <small id="strengthText">Password strength</small>
                    </div>

                    <div class="password-requirements">
                        <div class="requirement" id="req-length">
                            <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            <span class="pqr">At least 8 characters</span>
                        </div>
                        <div class="requirement" id="req-uppercase">
                            <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            <span class="pqr">One uppercase letter</span>
                        </div>
                        <div class="requirement" id="req-lowercase">
                            <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            <span class="pqr">One lowercase letter</span>
                        </div>
                        <div class="requirement" id="req-number">
                            <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            <span class="pqr">One number</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm New Password <span class="required">*</span></label>
                    <div class="input-container">
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                        </svg>
                        <input type="password" id="confirm_password" name="confirm_password"
                            placeholder="Re-enter new password" required autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePasswordField('confirm_password')">
                            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <svg class="eye-closed hidden" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path
                                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" />
                                <line x1="1" y1="1" x2="23" y2="23" />
                            </svg>
                        </button>
                    </div>
                    <div class="password-match" id="passwordMatch" style="display: none; margin-top: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="color: var(--success-color);">
                            <polyline points="20 6 9 17 4 12" />
                        </svg>
                        <small style="color: var(--success-color); font-weight: 600;">Passwords match</small>
                    </div>
                </div>

                <input type="hidden" name="username" value="{{ username }}">

                <button type="submit" class="btn-primary" id="resetBtn">
                    <span>Reset Password</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                </button>
            </form>

            <div class="security-note">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                <p>After resetting your password, you'll be redirected to the login page to sign in with your new
                    credentials.</p>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-icon">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="#667eea" stroke-width="2" />
                <line x1="12" y1="8" x2="12" y2="12" stroke="#667eea" stroke-width="2" />
                <line x1="12" y1="16" x2="12.01" y2="16" stroke="#667eea" stroke-width="2" />
            </svg>
        </div>
        <h3>Reset Password?</h3>
        <p>Are you sure you want to reset your password? You'll need to use the new password to login.</p>
        <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
            <button type="button" class="btn-primary" onclick="confirmReset()">Yes, Reset Password</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal" id="successModal">
    <div class="modal-content success-modal">
        <div class="modal-icon">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="#10b981" stroke-width="2" />
                <path d="M8 12l2 2 4-4" stroke="#10b981" stroke-width="2" stroke-linecap="round" />
            </svg>
        </div>
        <h3>Password Reset Successful!</h3>
        <p>Your password has been reset successfully. Redirecting to login page...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Password Strength Checker
    const passwordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const resetBtn = document.getElementById('resetBtn');
    const passwordMatch = document.getElementById('passwordMatch');

    passwordInput.addEventListener('input', function () {
        const password = this.value;

        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password)
        };

        // Update requirement indicators
        document.getElementById('req-length').classList.toggle('met', requirements.length);
        document.getElementById('req-uppercase').classList.toggle('met', requirements.uppercase);
        document.getElementById('req-lowercase').classList.toggle('met', requirements.lowercase);
        document.getElementById('req-number').classList.toggle('met', requirements.number);

        // Calculate strength
        const strength = Object.values(requirements).filter(Boolean).length;

        if (strength === 0) {
            strengthFill.className = 'strength-fill';
            strengthFill.style.width = '0%';
            strengthText.textContent = 'Password strength';
            strengthText.style.color = '';
        } else if (strength <= 2) {
            strengthFill.className = 'strength-fill weak';
            strengthText.textContent = 'Weak password';
            strengthText.style.color = '#ef4444';
        } else if (strength === 3) {
            strengthFill.className = 'strength-fill medium';
            strengthText.textContent = 'Medium password';
            strengthText.style.color = '#f59e0b';
        } else {
            strengthFill.className = 'strength-fill strong';
            strengthText.textContent = 'Strong password';
            strengthText.style.color = '#10b981';
        }

        // Check password match
        checkPasswordMatch();
    });

    confirmPasswordInput.addEventListener('input', checkPasswordMatch);

    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword.length > 0) {
            if (password === confirmPassword) {
                passwordMatch.style.display = 'flex';
                passwordMatch.style.alignItems = 'center';
                passwordMatch.style.gap = '8px';
                confirmPasswordInput.style.borderColor = 'var(--success-color)';
            } else {
                passwordMatch.style.display = 'none';
                confirmPasswordInput.style.borderColor = 'var(--error-color)';
            }
        } else {
            passwordMatch.style.display = 'none';
            confirmPasswordInput.style.borderColor = '';
        }
    }

    // Toggle Password Visibility
    function togglePasswordField(fieldId) {
        const input = document.getElementById(fieldId);
        const button = input.parentElement.querySelector('.password-toggle');
        const eyeOpen = button.querySelector('.eye-open');
        const eyeClosed = button.querySelector('.eye-closed');

        if (input.type === 'password') {
            input.type = 'text';
            eyeOpen.classList.add('hidden');
            eyeClosed.classList.remove('hidden');
        } else {
            input.type = 'password';
            eyeOpen.classList.remove('hidden');
            eyeClosed.classList.add('hidden');
        }
    }

    // Form Validation and Submission
    document.getElementById('resetPasswordForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // Validate password strength
        const isStrong = password.length >= 8 &&
            /[A-Z]/.test(password) &&
            /[a-z]/.test(password) &&
            /[0-9]/.test(password);

        if (!isStrong) {
            showAlert('Please create a stronger password that meets all requirements', 'error');
            return;
        }

        // Validate password match
        if (password !== confirmPassword) {
            showAlert('Passwords do not match', 'error');
            return;
        }

        // Show confirmation modal
        document.getElementById('confirmModal').classList.add('active');
    });

    function confirmReset() {
        closeModal('confirmModal');

        // Submit the form
        const form = document.getElementById('resetPasswordForm');

        // For demo: show success modal
        // In production, wait for server response
        setTimeout(() => {
            document.getElementById('successModal').classList.add('active');

            // Redirect after 2 seconds
            setTimeout(() => {
                form.submit();
                // window.location.href = '/login';
            }, 2000);
        }, 500);
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        ${message}
    `;

        const formHeader = document.querySelector('.form-header');
        const existingAlert = formHeader.nextElementSibling;
        if (existingAlert && existingAlert.classList.contains('alert')) {
            existingAlert.remove();
        }
        formHeader.after(alert);

        setTimeout(() => alert.remove(), 5000);
    }

    // Close modal when clicking outside
    window.addEventListener('click', function (e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
        }
    });
</script>
{% endblock %}