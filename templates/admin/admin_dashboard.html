{% extends 'admin/admin_base.html' %}

{% block sidebar_class %}static-expanded{% endblock %}

{% block admin_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
{% endblock %}

{% block admin_content %}

<!-- Main Content Area -->
<div class="admin-dashboard-wrapper with-static-sidebar">
  <div class="admin-header">
    <div class="admin-header-content">
      <div class="admin-title-section">
        <h1>Admin Dashboard</h1>
        <p class="admin-subtitle">
          Welcome back <b style="color:white;">"{{ admins|capitalize }}"</b>! Here's what's happening with MoodMatch
          today.
        </p>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="admin-content">
    <!-- Stats Cards -->
    <div class="admin-stats-grid">
      <div class="admin-stat-card blue">
        <div class="admin-stat-header">
          <div class="admin-stat-info">
            <div class="admin-stat-label">Total Users</div>
            <div class="admin-stat-value">{{ total_users }}</div>
          </div>
          <div class="admin-stat-icon">ğŸ‘¥</div>
        </div>
        <div class="admin-stat-footer">
          <span class="admin-stat-trend up">â†‘ 12%</span>
          <span>vs last month</span>
        </div>
      </div>

      <div class="admin-stat-card cyan">
        <div class="admin-stat-header">
          <div class="admin-stat-info">
            <div class="admin-stat-label">Total Activities</div>
            <div class="admin-stat-value">{{ total_activities }}</div>
          </div>
          <div class="admin-stat-icon">ğŸ¯</div>
        </div>
        <div class="admin-stat-footer">
          <span class="admin-stat-trend up">â†‘ 8%</span>
          <span>vs last month</span>
        </div>
      </div>

      <div class="admin-stat-card purple">
        <div class="admin-stat-header">
          <div class="admin-stat-info">
            <div class="admin-stat-label">Engagement Rate</div>
            <div class="admin-stat-value">87.5%</div>
          </div>
          <div class="admin-stat-icon">ğŸ“ˆ</div>
        </div>
        <div class="admin-stat-footer">
          <span class="admin-stat-trend up">â†‘ 3.2%</span>
          <span>vs last month</span>
        </div>
      </div>

      <div class="admin-stat-card green">
        <div class="admin-stat-header">
          <div class="admin-stat-info">
            <div class="admin-stat-label">Active Today</div>
            <div class="admin-stat-value">{{ registered_today }}</div>
          </div>
          <div class="admin-stat-icon">âœ¨</div>
        </div>
        <div class="admin-stat-footer">
          <span class="admin-stat-trend down">â†“ 2%</span>
          <span>vs yesterday</span>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="admin-content-grid">
      <!-- Chart Card -->
      <div class="admin-chart-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">User Growth</h2>
          <div class="admin-card-actions">
            <button class="admin-filter-btn active">7 Days</button>
            <button class="admin-filter-btn">30 Days</button>
            <button class="admin-filter-btn">90 Days</button>
          </div>
        </div>
        <div class="admin-chart-placeholder">
          <div class="admin-chart-placeholder-content">
            <div class="admin-chart-placeholder-icon">ğŸ“Š</div>
            <p>Chart visualization area</p>
            <small style="color: var(--admin-text-muted)">Integrate Chart.js or Recharts here</small>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="admin-activity-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Recent Activity</h2>
        </div>
        <div class="admin-activity-list">
          <div class="admin-activity-item">
            <div class="admin-activity-avatar">JD</div>
            <div class="admin-activity-content">
              <div class="admin-activity-text">
                <strong>John Doe</strong> registered a new account
              </div>
              <div class="admin-activity-time">2 minutes ago</div>
            </div>
          </div>

          <div class="admin-activity-item">
            <div class="admin-activity-avatar">SM</div>
            <div class="admin-activity-content">
              <div class="admin-activity-text">
                <strong>Sarah Miller</strong> added a new activity
              </div>
              <div class="admin-activity-time">15 minutes ago</div>
            </div>
          </div>

          <div class="admin-activity-item">
            <div class="admin-activity-avatar">RJ</div>
            <div class="admin-activity-content">
              <div class="admin-activity-text">
                <strong>Robert Johnson</strong> updated profile
              </div>
              <div class="admin-activity-time">1 hour ago</div>
            </div>
          </div>

          <div class="admin-activity-item">
            <div class="admin-activity-avatar">EW</div>
            <div class="admin-activity-content">
              <div class="admin-activity-text">
                <strong>Emma Wilson</strong> favorited 3 activities
              </div>
              <div class="admin-activity-time">2 hours ago</div>
            </div>
          </div>

          <div class="admin-activity-item">
            <div class="admin-activity-avatar">MB</div>
            <div class="admin-activity-content">
              <div class="admin-activity-text">
                <strong>Michael Brown</strong> completed a survey
              </div>
              <div class="admin-activity-time">3 hours ago</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Users Table -->
    <div class="admin-table-card">
      <div class="admin-table-header">
        <h2 class="admin-card-title">Recent Users</h2>
        <div class="admin-search-box">
          <input type="text" class="admin-search-input" placeholder="Search users..." />
          <span class="admin-search-icon">ğŸ”</span>
        </div>
      </div>
      {% if users %}
      <table class="admin-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div class="admin-activity-avatar" style="width: 32px; height: 32px; font-size: 0.75rem;">
                  {{ (user.username.split('.')[0][0] + user.username.split('.')[1][0])|upper }}
                </div>
                <strong>
                  {{ user.first_name or '' }} {{ user.last_name or user.username or 'Unknown' }}
                </strong>
              </div>
            </td>
            <td>{{ user.email or 'â€”' }}</td>
            <td>{{ user.created_at[:10] }}</td>
            <td>
              <div class="admin-table-actions">
                <button class="admin-icon-btn" title="View" onclick="viewUser({{ user.id }})">ğŸ‘ï¸</button>
                <button class="admin-icon-btn" title="Edit" onclick="editUser({{ user.id }})">âœï¸</button>
                <button class="admin-icon-btn" title="Delete" onclick="deleteUser({{ user.id }})">ğŸ—‘ï¸</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p style="text-align:center; color:#64748b; padding:2rem;">
        No users found in the database.
      </p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function viewUser(userId) {
    ModalSystem.view({
      title: 'User Details',
      content: `<p>Viewing user ID: ${userId}</p>`
    });
  }

  function editUser(userId) {
    ModalSystem.form({
      title: 'Edit User',
      fields: [
        { label: 'Name', name: 'name', type: 'text', required: true },
        { label: 'Email', name: 'email', type: 'email', required: true }
      ],
      onSubmit: (data) => {
        console.log('Update user:', userId, data);
        ModalSystem.success({
          title: 'Updated!',
          message: 'User has been updated successfully.'
        });
      }
    });
  }

  function deleteUser(userId) {
    ModalSystem.deleteConfirm({
      title: 'Delete User',
      message: 'Are you sure you want to delete this user?',
      onConfirm: () => {
        console.log('Delete user:', userId);
        ModalSystem.success({
          title: 'Deleted!',
          message: 'User has been deleted.'
        });
      }
    });
  }

  function initializePageScripts() {
    // Filter Buttons
    const filterBtns = document.querySelectorAll(".admin-filter-btn");
    filterBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        filterBtns.forEach((b) => b.classList.remove("active"));
        this.classList.add("active");
        console.log("Filter changed to:", this.textContent);
      });
    });

    // Search Functionality
    const searchInput = document.querySelector(".admin-search-input");
    if (searchInput) {
      searchInput.addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const tableRows = document.querySelectorAll(".admin-table tbody tr");

        tableRows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? "" : "none";
        });
      });
    }
  }
</script>

{% endblock %}